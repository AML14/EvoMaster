<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>H2ConstraintExtractor.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">evomaster-project-report</a> &gt; <a href="../index.html" class="el_bundle">evomaster-client-java-controller</a> &gt; <a href="index.source.html" class="el_package">org.evomaster.client.java.controller.internal.db.constraint</a> &gt; <span class="el_source">H2ConstraintExtractor.java</span></div><h1>H2ConstraintExtractor.java</h1><pre class="source lang-java linenums">package org.evomaster.client.java.controller.internal.db.constraint;


import org.evomaster.client.java.controller.api.dto.database.schema.DbSchemaDto;
import org.evomaster.client.java.controller.api.dto.database.schema.TableDto;
import org.evomaster.client.java.utils.SimpleLogger;

import java.sql.Connection;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.stream.Collectors;

<span class="fc" id="L17">public class H2ConstraintExtractor extends TableConstraintExtractor {</span>

    public static final String CONSTRAINT_TYPE = &quot;CONSTRAINT_TYPE&quot;;
    public static final String CHECK_EXPRESSION = &quot;CHECK_EXPRESSION&quot;;
    public static final String COLUMN_LIST = &quot;COLUMN_LIST&quot;;
    public static final String UNIQUE = &quot;UNIQUE&quot;;
    public static final String REFERENTIAL = &quot;REFERENTIAL&quot;;
    public static final String PRIMARY_KEY = &quot;PRIMARY_KEY&quot;;
    public static final String PRIMARY_KEY_BLANK = &quot;PRIMARY KEY&quot;;
    public static final String CHECK = &quot;CHECK&quot;;

    /**
     * Expects the schema explained in
     * http://www.h2database.com/html/systemtables.html#information_schema
     *
     * @param connectionToH2 a connection to a H2 database
     * @param schemaDto      a DTO schema with retrieved information from the JBDC metada
     * @throws Exception
     */
    public List&lt;DbTableConstraint&gt; extract(Connection connectionToH2, DbSchemaDto schemaDto) throws SQLException {

<span class="fc" id="L38">        List&lt;DbTableConstraint&gt; columnConstraints = extractColumnConstraints(connectionToH2, schemaDto);</span>

<span class="fc" id="L40">        List&lt;DbTableConstraint&gt; tableCheckExpressions = extractTableConstraints(connectionToH2, schemaDto);</span>

<span class="fc" id="L42">        List&lt;DbTableConstraint&gt; allConstraints = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L43">        allConstraints.addAll(columnConstraints);</span>
<span class="fc" id="L44">        allConstraints.addAll(tableCheckExpressions);</span>
<span class="fc" id="L45">        return allConstraints;</span>
    }

    /**
     * Logs that a constraint could not be handled by the extractor.
     *
     * @param constraintType
     */
    private static void cannotHandle(String constraintType) {
<span class="nc" id="L54">        SimpleLogger.uniqueWarn(&quot;WARNING, EvoMaster cannot extract H2 constraints with type '&quot; + constraintType);</span>
<span class="nc" id="L55">    }</span>

    /**
     * For each table in the schema DTO, this method appends
     * the constraints that are originated in the ALTER TABLE commands
     * for those particular tables.
     * &lt;p&gt;
     * Foreign keys are handled separately in the JDBC metadata
     *
     * @param connectionToH2 a connection to a H2 database
     * @param schemaDto
     * @throws SQLException if the connection to the H2 database fails,
     */
    private List&lt;DbTableConstraint&gt; extractTableConstraints(Connection connectionToH2, DbSchemaDto schemaDto) throws SQLException {

<span class="fc" id="L70">        List&lt;DbTableConstraint&gt; tableCheckExpressions = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L72">        String tableSchema = schemaDto.name;</span>
<span class="fc bfc" id="L73" title="All 2 branches covered.">        for (TableDto tableDto : schemaDto.tables) {</span>
<span class="fc" id="L74">            String tableName = tableDto.name;</span>
<span class="fc" id="L75">            try (Statement statement = connectionToH2.createStatement()) {</span>

<span class="fc" id="L77">                final String query = String.format(&quot;Select * From INFORMATION_SCHEMA.CONSTRAINTS\n&quot; +</span>
                        &quot; where CONSTRAINTS.TABLE_SCHEMA='%s' \n&quot;
                        + &quot; and CONSTRAINTS.TABLE_NAME='%s' &quot;, tableSchema, tableName);
<span class="fc" id="L80">                try (ResultSet constraints = statement.executeQuery(query)) {</span>

<span class="fc bfc" id="L82" title="All 2 branches covered.">                    while (constraints.next()) {</span>
<span class="fc" id="L83">                        String constraintType = constraints.getString(CONSTRAINT_TYPE);</span>
<span class="fc" id="L84">                        String sqlCheckExpression = constraints.getString(CHECK_EXPRESSION);</span>
<span class="fc" id="L85">                        String columnList = constraints.getString(COLUMN_LIST);</span>
                        DbTableConstraint constraint;
<span class="pc bpc" id="L87" title="1 of 4 branches missed.">                        switch (constraintType) {</span>
                            case UNIQUE:
<span class="fc" id="L89">                                List&lt;String&gt; uniqueColumnNames = Arrays.stream(columnList.split(&quot;,&quot;)).map(String::trim).collect(Collectors.toList());</span>
<span class="fc" id="L90">                                constraint = new DbTableUniqueConstraint(tableName, uniqueColumnNames);</span>
<span class="fc" id="L91">                                tableCheckExpressions.add(constraint);</span>
<span class="fc" id="L92">                                break;</span>
                            case PRIMARY_KEY:
                            case PRIMARY_KEY_BLANK:
                            case REFERENTIAL:
                                /**
                                 * This type of constraint is already handled by
                                 * JDBC Metadata
                                 **/
<span class="fc" id="L100">                                break;</span>
                            case CHECK:
<span class="fc" id="L102">                                constraint = new DbTableCheckExpression(tableName, sqlCheckExpression);</span>
<span class="fc" id="L103">                                tableCheckExpressions.add(constraint);</span>
<span class="fc" id="L104">                                break;</span>

                            default:
<span class="nc" id="L107">                                cannotHandle(constraintType);</span>
                        }
<span class="fc" id="L109">                    }</span>
                }
            }
<span class="fc" id="L112">        }</span>

<span class="fc" id="L114">        return tableCheckExpressions;</span>
    }

    /**
     * For each table in the schema DTO, this method appends
     * the constraints that are originated in the CREATE TABLE commands
     * for those particular tables.
     * &lt;p&gt;
     * Unique constraints and Foreign keys are handled separately in the JDBC metadata
     *
     * @param connectionToH2 a connection to a H2 database
     * @param schemaDto
     * @throws SQLException if the connection to the database fails
     */
    private List&lt;DbTableConstraint&gt; extractColumnConstraints(Connection connectionToH2, DbSchemaDto schemaDto) throws SQLException {
<span class="fc" id="L129">        String tableSchema = schemaDto.name;</span>
<span class="fc" id="L130">        List&lt;DbTableConstraint&gt; columnConstraints = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L131" title="All 2 branches covered.">        for (TableDto tableDto : schemaDto.tables) {</span>
<span class="fc" id="L132">            String tableName = tableDto.name;</span>

<span class="fc" id="L134">            try (Statement statement = connectionToH2.createStatement()) {</span>

<span class="fc" id="L136">                final String query = String.format(&quot;Select * From INFORMATION_SCHEMA.COLUMNS where COLUMNS.TABLE_SCHEMA='%s' and COLUMNS.TABLE_NAME='%s' &quot;, tableSchema, tableName);</span>

<span class="fc" id="L138">                try (ResultSet columns = statement.executeQuery(query)) {</span>
<span class="fc bfc" id="L139" title="All 2 branches covered.">                    while (columns.next()) {</span>
<span class="fc" id="L140">                        String sqlCheckExpression = columns.getString(&quot;CHECK_CONSTRAINT&quot;);</span>
<span class="pc bpc" id="L141" title="1 of 4 branches missed.">                        if (sqlCheckExpression != null &amp;&amp; !sqlCheckExpression.equals(&quot;&quot;)) {</span>
<span class="fc" id="L142">                            DbTableCheckExpression constraint = new DbTableCheckExpression(tableName, sqlCheckExpression);</span>
<span class="fc" id="L143">                            columnConstraints.add(constraint);</span>
                        }
<span class="fc" id="L145">                    }</span>
                }
            }
<span class="fc" id="L148">        }</span>
<span class="fc" id="L149">        return columnConstraints;</span>
    }

}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>