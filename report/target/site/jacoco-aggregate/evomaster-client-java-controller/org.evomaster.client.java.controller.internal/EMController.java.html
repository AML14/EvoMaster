<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>EMController.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">evomaster-project-report</a> &gt; <a href="../index.html" class="el_bundle">evomaster-client-java-controller</a> &gt; <a href="index.source.html" class="el_package">org.evomaster.client.java.controller.internal</a> &gt; <span class="el_source">EMController.java</span></div><h1>EMController.java</h1><pre class="source lang-java linenums">package org.evomaster.client.java.controller.internal;

import org.evomaster.client.java.controller.api.ControllerConstants;
import org.evomaster.client.java.controller.api.Formats;
import org.evomaster.client.java.controller.api.dto.*;
import org.evomaster.client.java.controller.api.dto.database.operations.DatabaseCommandDto;
import org.evomaster.client.java.controller.api.dto.problem.RestProblemDto;
import org.evomaster.client.java.controller.db.QueryResult;
import org.evomaster.client.java.controller.db.SqlScriptRunner;
import org.evomaster.client.java.controller.problem.ProblemInfo;
import org.evomaster.client.java.controller.problem.RestProblem;
import org.evomaster.client.java.instrumentation.TargetInfo;
import org.evomaster.client.java.utils.SimpleLogger;

import javax.ws.rs.*;
import javax.ws.rs.core.MediaType;
import javax.ws.rs.core.Response;
import java.sql.Connection;
import java.util.*;
import java.util.stream.Collectors;

/**
 * Note: usually a RESTful webservice would be stateless.
 * Here, however, we have state. Reason is that we need it,
 * and the only client is the EvoMaster process. Furthermore,
 * the code of the controller should be as simple as possible,
 * as we might need to re-implement it in different languages.
 */
@Path(&quot;&quot;)
@Produces(Formats.JSON_V1)
public class EMController {

    private final SutController sutController;
    private String baseUrlOfSUT;

<span class="fc" id="L36">    public EMController(SutController sutController) {</span>
<span class="fc" id="L37">        this.sutController = Objects.requireNonNull(sutController);</span>
<span class="fc" id="L38">    }</span>


    @Path(ControllerConstants.INFO_SUT_PATH)
    @GET
    public Response getSutInfo() {

<span class="fc" id="L45">        SutInfoDto dto = new SutInfoDto();</span>
<span class="fc" id="L46">        dto.isSutRunning = sutController.isSutRunning();</span>
<span class="fc" id="L47">        dto.baseUrlOfSUT = baseUrlOfSUT;</span>
<span class="fc" id="L48">        dto.infoForAuthentication = sutController.getInfoForAuthentication();</span>
<span class="fc" id="L49">        dto.sqlSchemaDto = sutController.getSqlDatabaseSchema();</span>
<span class="fc" id="L50">        dto.defaultOutputFormat = sutController.getPreferredOutputFormat();</span>

<span class="fc" id="L52">        ProblemInfo info = sutController.getProblemInfo();</span>
<span class="pc bpc" id="L53" title="1 of 2 branches missed.">        if (info == null) {</span>
<span class="nc" id="L54">            String msg = &quot;Undefined problem type in the EM Controller&quot;;</span>
<span class="nc" id="L55">            SimpleLogger.error(msg);</span>
<span class="nc" id="L56">            return Response.status(500).entity(WrappedResponseDto.withError(msg)).build();</span>

<span class="pc bpc" id="L58" title="1 of 2 branches missed.">        } else if (info instanceof RestProblem) {</span>
<span class="fc" id="L59">            RestProblem rp = (RestProblem) info;</span>
<span class="fc" id="L60">            dto.restProblem = new RestProblemDto();</span>
<span class="fc" id="L61">            dto.restProblem.swaggerJsonUrl = rp.getSwaggerJsonUrl();</span>
<span class="fc" id="L62">            dto.restProblem.endpointsToSkip = rp.getEndpointsToSkip();</span>

<span class="fc" id="L64">        } else {</span>
<span class="nc" id="L65">            String msg = &quot;Unrecognized problem type: &quot; + info.getClass().getName();</span>
<span class="nc" id="L66">            SimpleLogger.error(msg);</span>
<span class="nc" id="L67">            return Response.status(500).entity(WrappedResponseDto.withError(msg)).build();</span>
        }

<span class="fc" id="L70">        return Response.status(200).entity(WrappedResponseDto.withData(dto)).build();</span>
    }

    @Path(ControllerConstants.CONTROLLER_INFO)
    @GET
    public Response getControllerInfoDto() {

<span class="nc" id="L77">        ControllerInfoDto dto = new ControllerInfoDto();</span>
<span class="nc" id="L78">        dto.fullName = sutController.getClass().getName();</span>
<span class="nc" id="L79">        dto.isInstrumentationOn = sutController.isInstrumentationActivated();</span>

<span class="nc" id="L81">        return Response.status(200).entity(WrappedResponseDto.withData(dto)).build();</span>
    }

    @Path(ControllerConstants.NEW_SEARCH)
    @POST
    public Response newSearch() {
<span class="nc" id="L87">        sutController.newSearch();</span>

<span class="nc" id="L89">        return Response.status(201).entity(WrappedResponseDto.withNoData()).build();</span>
    }


    @Path(ControllerConstants.RUN_SUT_PATH)
    @PUT
    @Consumes(Formats.JSON_V1)
    public Response runSut(SutRunDto dto) {

        try {
<span class="pc bpc" id="L99" title="1 of 2 branches missed.">            if (dto.run == null) {</span>
<span class="nc" id="L100">                String msg = &quot;Invalid JSON: 'run' field is required&quot;;</span>
<span class="nc" id="L101">                SimpleLogger.warn(msg);</span>
<span class="nc" id="L102">                return Response.status(400).entity(WrappedResponseDto.withError(msg)).build();</span>
            }

<span class="pc bpc" id="L105" title="1 of 4 branches missed.">            boolean doReset = dto.resetState != null &amp;&amp; dto.resetState;</span>

<span class="fc" id="L107">            synchronized (this) {</span>

<span class="pc bpc" id="L109" title="1 of 2 branches missed.">                if (!dto.run) {</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">                    if (doReset) {</span>
<span class="nc" id="L111">                        String msg = &quot;Invalid JSON: cannot reset state and stop service at same time&quot;;</span>
<span class="nc" id="L112">                        SimpleLogger.warn(msg);</span>
<span class="nc" id="L113">                        return Response.status(400).entity(WrappedResponseDto.withError(msg)).build();</span>
                    }

                    //if on, we want to shut down the server
<span class="nc bnc" id="L117" title="All 2 branches missed.">                    if (sutController.isSutRunning()) {</span>
<span class="nc" id="L118">                        sutController.stopSut();</span>
<span class="nc" id="L119">                        baseUrlOfSUT = null;</span>
                    }

                } else {
                    /*
                        If SUT is not up and running, let's start it
                     */
<span class="pc bpc" id="L126" title="1 of 2 branches missed.">                    if (!sutController.isSutRunning()) {</span>
<span class="fc" id="L127">                        baseUrlOfSUT = sutController.startSut();</span>
<span class="pc bpc" id="L128" title="1 of 2 branches missed.">                        if (baseUrlOfSUT == null) {</span>
                            //there has been an internal failure in starting the SUT
<span class="nc" id="L130">                            String msg = &quot;Internal failure: cannot start SUT based on given configuration&quot;;</span>
<span class="nc" id="L131">                            SimpleLogger.warn(msg);</span>
<span class="nc" id="L132">                            return Response.status(500).entity(WrappedResponseDto.withError(msg)).build();</span>
                        }
<span class="fc" id="L134">                        sutController.initSqlHandler();</span>
                    } else {
                        //TODO as starting should be blocking, need to check
                        //if initialized, and wait if not
                    }

                    /*
                        regardless of where it was running or not, need to reset state.
                        this is controlled by a boolean, although most likely we ll always
                        want to do it
                     */
<span class="pc bpc" id="L145" title="1 of 4 branches missed.">                    if (dto.resetState != null &amp;&amp; dto.resetState) {</span>
<span class="fc" id="L146">                        sutController.resetStateOfSUT();</span>
<span class="fc" id="L147">                        sutController.newTest();</span>
                    }

                    /*
                        Note: here even if we start the SUT, the starting of a &quot;New Search&quot;
                        cannot be done here, as in this endpoint we also deal with the reset
                        of state. When we reset state for a new test run, we do not want to
                        reset all the other data regarding the whole search
                     */
                }
<span class="fc" id="L157">            }</span>
<span class="nc" id="L158">        } catch (RuntimeException e) {</span>
            /*
                FIXME: ideally, would not need to do a try/catch on each single endpoint,
                as could configure Jetty/Jackson to log all errors.
                But even after spending hours googling it, haven't managed to configure it
             */

<span class="nc" id="L165">            String msg = e.getMessage();</span>
<span class="nc" id="L166">            SimpleLogger.error(msg);</span>
<span class="nc" id="L167">            return Response.status(500).entity(WrappedResponseDto.withError(msg)).build();</span>
<span class="fc" id="L168">        }</span>

<span class="fc" id="L170">        return Response.status(204).entity(WrappedResponseDto.withNoData()).build();</span>
    }


    @Path(ControllerConstants.TEST_RESULTS)
    @GET
    public Response getTestResults(
            @QueryParam(&quot;ids&quot;)
            @DefaultValue(&quot;&quot;)
                    String idList) {

        try {
<span class="fc" id="L182">            TestResultsDto dto = new TestResultsDto();</span>

            Set&lt;Integer&gt; ids;

            try {
<span class="fc" id="L187">                ids = Arrays.stream(idList.split(&quot;,&quot;))</span>
<span class="pc bpc" id="L188" title="1 of 2 branches missed.">                        .filter(s -&gt; !s.trim().isEmpty())</span>
<span class="fc" id="L189">                        .map(Integer::parseInt)</span>
<span class="fc" id="L190">                        .collect(Collectors.toSet());</span>
<span class="nc" id="L191">            } catch (NumberFormatException e) {</span>
<span class="nc" id="L192">                String msg = &quot;Invalid parameter 'ids': &quot; + e.getMessage();</span>
<span class="nc" id="L193">                SimpleLogger.warn(msg);</span>
<span class="nc" id="L194">                return Response.status(400).entity(WrappedResponseDto.withError(msg)).build();</span>
<span class="fc" id="L195">            }</span>

<span class="fc" id="L197">            List&lt;TargetInfo&gt; list = sutController.getTargetInfos(ids);</span>
<span class="pc bpc" id="L198" title="1 of 2 branches missed.">            if (list == null) {</span>
<span class="nc" id="L199">                String msg = &quot;Failed to collect target information for &quot; + ids.size() + &quot; ids&quot;;</span>
<span class="nc" id="L200">                SimpleLogger.error(msg);</span>
<span class="nc" id="L201">                return Response.status(500).entity(WrappedResponseDto.withError(msg)).build();</span>
            }

<span class="fc" id="L204">            list.forEach(t -&gt; {</span>
<span class="nc" id="L205">                TargetInfoDto info = new TargetInfoDto();</span>
<span class="nc" id="L206">                info.id = t.mappedId;</span>
<span class="nc" id="L207">                info.value = t.value;</span>
<span class="nc" id="L208">                info.descriptiveId = t.descriptiveId;</span>
<span class="nc" id="L209">                info.actionIndex = t.actionIndex;</span>

<span class="nc" id="L211">                dto.targets.add(info);</span>
<span class="nc" id="L212">            });</span>

<span class="fc" id="L214">            sutController.getAdditionalInfoList().forEach(a -&gt; {</span>
<span class="fc" id="L215">                AdditionalInfoDto info = new AdditionalInfoDto();</span>
<span class="fc" id="L216">                info.queryParameters = new HashSet&lt;&gt;(a.getQueryParametersView());</span>
<span class="fc" id="L217">                info.headers = new HashSet&lt;&gt;(a.getHeadersView());</span>

<span class="fc" id="L219">                dto.additionalInfoList.add(info);</span>
<span class="fc" id="L220">            });</span>

<span class="fc" id="L222">            dto.extraHeuristics = sutController.getExtraHeuristics();</span>

<span class="fc" id="L224">            return Response.status(200).entity(WrappedResponseDto.withData(dto)).build();</span>

<span class="nc" id="L226">        } catch (RuntimeException e) {</span>
            /*
                FIXME: ideally, would not need to do a try/catch on each single endpoint,
                as could configure Jetty/Jackson to log all errors.
                But even after spending hours googling it, haven't managed to configure it
             */

<span class="nc" id="L233">            String msg = e.getMessage();</span>
<span class="nc" id="L234">            SimpleLogger.error(msg);</span>
<span class="nc" id="L235">            return Response.status(500).entity(WrappedResponseDto.withError(msg)).build();</span>
        }
    }


    @Path(ControllerConstants.NEW_ACTION)
    @Consumes(MediaType.APPLICATION_JSON)
    @PUT
    public Response newAction(int index) {

<span class="fc" id="L245">        sutController.newAction(index);</span>

<span class="fc" id="L247">        return Response.status(204).entity(WrappedResponseDto.withNoData()).build();</span>
    }


    @Path(ControllerConstants.DATABASE_COMMAND)
    @Consumes(Formats.JSON_V1)
    @POST
    public Response executeDatabaseCommand(DatabaseCommandDto dto) {

<span class="fc" id="L256">        Connection connection = sutController.getConnection();</span>
<span class="pc bpc" id="L257" title="1 of 2 branches missed.">        if (connection == null) {</span>
<span class="nc" id="L258">            String msg = &quot;No active database connection&quot;;</span>
<span class="nc" id="L259">            SimpleLogger.warn(msg);</span>
<span class="nc" id="L260">            return Response.status(400).entity(WrappedResponseDto.withError(msg)).build();</span>
        }

<span class="pc bpc" id="L263" title="5 of 6 branches missed.">        if (dto.command == null &amp;&amp; (dto.insertions == null || dto.insertions.isEmpty())) {</span>
<span class="nc" id="L264">            String msg = &quot;No input command&quot;;</span>
<span class="nc" id="L265">            SimpleLogger.warn(msg);</span>
<span class="nc" id="L266">            return Response.status(400).entity(WrappedResponseDto.withError(msg)).build();</span>
        }

<span class="pc bpc" id="L269" title="3 of 6 branches missed.">        if (dto.command != null &amp;&amp; dto.insertions != null &amp;&amp; !dto.insertions.isEmpty()) {</span>
<span class="nc" id="L270">            String msg = &quot;Only 1 command can be specified&quot;;</span>
<span class="nc" id="L271">            SimpleLogger.warn(msg);</span>
<span class="nc" id="L272">            return Response.status(400).entity(WrappedResponseDto.withError(msg)).build();</span>
        }


<span class="fc" id="L276">        QueryResult queryResult = null;</span>
<span class="fc" id="L277">        Map&lt;Long,Long&gt; idMapping = null;</span>

        try {
<span class="pc bpc" id="L280" title="1 of 2 branches missed.">            if (dto.command != null) {</span>
<span class="fc" id="L281">                queryResult = SqlScriptRunner.execCommand(connection, dto.command);</span>
            } else {
<span class="nc" id="L283">                idMapping = SqlScriptRunner.execInsert(connection, dto.insertions);</span>
            }
<span class="nc" id="L285">        } catch (Exception e) {</span>
<span class="nc" id="L286">            String msg = &quot;Failed to execute database command: &quot; + e.getMessage();</span>
<span class="nc" id="L287">            SimpleLogger.warn(msg);</span>
<span class="nc" id="L288">            return Response.status(400).entity(WrappedResponseDto.withError(msg)).build();</span>
<span class="fc" id="L289">        }</span>

<span class="pc bpc" id="L291" title="1 of 2 branches missed.">        if (queryResult != null) {</span>
<span class="fc" id="L292">            return Response.status(200).entity(WrappedResponseDto.withData(queryResult.toDto())).build();</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">        } else if(idMapping != null) {</span>
<span class="nc" id="L294">            return Response.status(200).entity(WrappedResponseDto.withData(idMapping)).build();</span>
        } else {
<span class="nc" id="L296">            return Response.status(204).entity(WrappedResponseDto.withNoData()).build();</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>