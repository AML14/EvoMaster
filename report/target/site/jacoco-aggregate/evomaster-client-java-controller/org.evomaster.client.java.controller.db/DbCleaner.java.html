<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>DbCleaner.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">evomaster-project-report</a> &gt; <a href="../index.html" class="el_bundle">evomaster-client-java-controller</a> &gt; <a href="index.source.html" class="el_package">org.evomaster.client.java.controller.db</a> &gt; <span class="el_source">DbCleaner.java</span></div><h1>DbCleaner.java</h1><pre class="source lang-java linenums">package org.evomaster.client.java.controller.db;

import java.sql.Connection;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.HashSet;
import java.util.List;
import java.util.Set;
import java.util.stream.Collectors;

/**
 * Class used to clean/reset the state of the current database
 */
<span class="nc" id="L15">public class DbCleaner {</span>

    public static void clearDatabase_Derby(Connection connection, String schemaName) {

        /*
            Code from
            https://stackoverflow.com/questions/171727/delete-all-tables-in-derby-db
         */

<span class="nc" id="L24">        String sql = &quot;SELECT &quot; +</span>
                &quot;'ALTER TABLE '||S.SCHEMANAME||'.'||T.TABLENAME||' DROP CONSTRAINT '||C.CONSTRAINTNAME||';' &quot; +
                &quot;FROM &quot; +
                &quot;    SYS.SYSCONSTRAINTS C, &quot; +
                &quot;    SYS.SYSSCHEMAS S, &quot; +
                &quot;    SYS.SYSTABLES T &quot; +
                &quot;WHERE &quot; +
                &quot;    C.SCHEMAID = S.SCHEMAID &quot; +
                &quot;AND &quot; +
                &quot;    C.TABLEID = T.TABLEID &quot; +
                &quot;AND &quot; +
                &quot;S.SCHEMANAME = '&quot; + schemaName + &quot;' &quot; +
                &quot;UNION &quot; +
                &quot;SELECT 'DROP TABLE ' || schemaname ||'.' || tablename || ';' &quot; +
                &quot;FROM SYS.SYSTABLES &quot; +
                &quot;INNER JOIN SYS.SYSSCHEMAS ON SYS.SYSTABLES.SCHEMAID = SYS.SYSSCHEMAS.SCHEMAID &quot; +
                &quot;where schemaname='&quot; + schemaName + &quot;'&quot;;

        try {
<span class="nc" id="L43">            Statement s = connection.createStatement();</span>
<span class="nc" id="L44">            s.execute(sql);</span>
<span class="nc" id="L45">            s.close();</span>
<span class="nc" id="L46">        } catch (Exception e) {</span>
<span class="nc" id="L47">            throw new RuntimeException(e);</span>
<span class="nc" id="L48">        }</span>
<span class="nc" id="L49">    }</span>

    public static void clearDatabase_H2(Connection connection) {
<span class="nc" id="L52">        clearDatabase_H2(connection, null);</span>
<span class="nc" id="L53">    }</span>

    public static void clearDatabase_H2(Connection connection, List&lt;String&gt; tablesToSkip) {
<span class="nc" id="L56">        clearDatabase_H2(connection, &quot;PUBLIC&quot;, tablesToSkip);</span>
<span class="nc" id="L57">    }</span>

    public static void clearDatabase_H2(Connection connection, String schemaName, List&lt;String&gt; tablesToSkip) {
        /*
            Code based on
            https://stackoverflow.com/questions/8523423/reset-embedded-h2-database-periodically
         */

        try {
<span class="nc" id="L66">            Statement s = connection.createStatement();</span>

            /*
                For H2, we have to delete tables one at a time... but, to avoid issues
                with FKs, we must temporarily disable the integrity checks
             */
<span class="nc" id="L72">            s.execute(&quot;SET REFERENTIAL_INTEGRITY FALSE&quot;);</span>

<span class="nc" id="L74">            truncateTables(tablesToSkip, s, schemaName, false);</span>

<span class="nc" id="L76">            resetSequences(s, schemaName);</span>

<span class="nc" id="L78">            s.execute(&quot;SET REFERENTIAL_INTEGRITY TRUE&quot;);</span>
<span class="nc" id="L79">            s.close();</span>
<span class="nc" id="L80">        } catch (Exception e) {</span>
<span class="nc" id="L81">            throw new RuntimeException(e);</span>
<span class="nc" id="L82">        }</span>
<span class="nc" id="L83">    }</span>

    public static void clearDatabase_Postgres(Connection connection) {
<span class="nc" id="L86">        clearDatabase_Postgres(connection, &quot;public&quot;, null);</span>
<span class="nc" id="L87">    }</span>

    public static void clearDatabase_Postgres(Connection connection, String schemaName, List&lt;String&gt; tablesToSkip) {

        try {
<span class="nc" id="L92">            Statement s = connection.createStatement();</span>

<span class="nc" id="L94">            truncateTables(tablesToSkip, s, schemaName, true);</span>

<span class="nc" id="L96">            resetSequences(s, schemaName);</span>

<span class="nc" id="L98">            s.close();</span>
<span class="nc" id="L99">        } catch (Exception e) {</span>
<span class="nc" id="L100">            throw new RuntimeException(e);</span>
<span class="nc" id="L101">        }</span>
<span class="nc" id="L102">    }</span>

    private static void truncateTables(List&lt;String&gt; tablesToSkip, Statement s, String schema, boolean singleCommand) throws SQLException {

        // Find all tables and truncate them
<span class="nc" id="L107">        Set&lt;String&gt; tables = new HashSet&lt;&gt;();</span>
<span class="nc" id="L108">        ResultSet rs = s.executeQuery(&quot;SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES  where TABLE_SCHEMA='&quot; + schema + &quot;' AND (TABLE_TYPE='TABLE' OR TABLE_TYPE='BASE TABLE')&quot;);</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">        while (rs.next()) {</span>
<span class="nc" id="L110">            tables.add(rs.getString(1));</span>
        }
<span class="nc" id="L112">        rs.close();</span>

<span class="nc bnc" id="L114" title="All 2 branches missed.">        if (tables.isEmpty()) {</span>
<span class="nc" id="L115">            throw new IllegalStateException(&quot;Could not find any table&quot;);</span>
        }

<span class="nc bnc" id="L118" title="All 2 branches missed.">        if (tablesToSkip != null) {</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">            for (String skip : tablesToSkip) {</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">                if (!tables.stream().anyMatch(t -&gt; t.equalsIgnoreCase(skip))) {</span>
<span class="nc" id="L121">                    String msg = &quot;Asked to skip table '&quot; + skip + &quot;', but it does not exist.&quot;;</span>
<span class="nc" id="L122">                    msg += &quot; Existing tables in schema '&quot;+schema+&quot;': [&quot; +</span>
<span class="nc" id="L123">                            tables.stream().collect(Collectors.joining(&quot;, &quot;)) + &quot;]&quot;;</span>
<span class="nc" id="L124">                    throw new IllegalStateException(msg);</span>
                }
<span class="nc" id="L126">            }</span>
        }

<span class="nc" id="L129">        List&lt;String&gt; tablesToClear = tables.stream()</span>
<span class="nc bnc" id="L130" title="All 4 branches missed.">                .filter(n -&gt; tablesToSkip == null || tablesToSkip.isEmpty() ||</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">                        !tablesToSkip.stream().anyMatch(skip -&gt; skip.equalsIgnoreCase(n)))</span>
<span class="nc" id="L132">                .collect(Collectors.toList());</span>

<span class="nc bnc" id="L134" title="All 2 branches missed.">        if (singleCommand) {</span>
<span class="nc" id="L135">            String ts = tablesToClear.stream()</span>
<span class="nc" id="L136">                    .sorted()</span>
<span class="nc" id="L137">                    .collect(Collectors.joining(&quot;,&quot;));</span>

<span class="nc" id="L139">            s.executeUpdate(&quot;TRUNCATE TABLE &quot; + ts);</span>
<span class="nc" id="L140">        } else {</span>
            //note: if one at a time, need to make sure to first disable FK checks
<span class="nc bnc" id="L142" title="All 2 branches missed.">            for(String t : tablesToClear){</span>
<span class="nc" id="L143">                s.executeUpdate(&quot;TRUNCATE TABLE &quot; + t);</span>
<span class="nc" id="L144">            }</span>
        }
<span class="nc" id="L146">    }</span>

    private static void resetSequences(Statement s, String schema) throws SQLException {
        ResultSet rs;// Idem for sequences
<span class="nc" id="L150">        Set&lt;String&gt; sequences = new HashSet&lt;&gt;();</span>
<span class="nc" id="L151">        rs = s.executeQuery(&quot;SELECT SEQUENCE_NAME FROM INFORMATION_SCHEMA.SEQUENCES WHERE SEQUENCE_SCHEMA='&quot; + schema + &quot;'&quot;);</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">        while (rs.next()) {</span>
<span class="nc" id="L153">            sequences.add(rs.getString(1));</span>
        }
<span class="nc" id="L155">        rs.close();</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">        for (String seq : sequences) {</span>
<span class="nc" id="L157">            s.executeUpdate(&quot;ALTER SEQUENCE &quot; + seq + &quot; RESTART WITH 1&quot;);</span>
<span class="nc" id="L158">        }</span>

        /*
            Note: we reset all sequences from 1. But the original database might
            have used a different value.
            In most cases (99.99%), this should not be a problem.
            We could allow using different values in this API... but, maybe just easier
            for the user to reset it manually if really needed?
         */
<span class="nc" id="L167">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>