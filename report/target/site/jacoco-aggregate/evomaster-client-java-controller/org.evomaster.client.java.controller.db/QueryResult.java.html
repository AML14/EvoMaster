<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>QueryResult.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">evomaster-project-report</a> &gt; <a href="../index.html" class="el_bundle">evomaster-client-java-controller</a> &gt; <a href="index.source.html" class="el_package">org.evomaster.client.java.controller.db</a> &gt; <span class="el_source">QueryResult.java</span></div><h1>QueryResult.java</h1><pre class="source lang-java linenums">package org.evomaster.client.java.controller.db;

import org.evomaster.client.java.controller.api.dto.database.operations.QueryResultDto;

import java.sql.ResultSet;
import java.sql.ResultSetMetaData;
import java.util.ArrayList;
import java.util.List;
import java.util.Objects;
import java.util.stream.Collectors;


/**
 * The results of a SQL Select query, in a easy to parse/manipulate data structure
 * compared to java.sql.ResultSet.
 */
public class QueryResult {

<span class="fc" id="L19">    private final List&lt;VariableDescriptor&gt; variableDescriptors = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L20">    private final List&lt;DataRow&gt; rows = new ArrayList&lt;&gt;();</span>

    /**
     * Constructor only needed for testing
     */
<span class="fc" id="L25">    public QueryResult(List&lt;String&gt; columnNames, String tableName) {</span>
<span class="fc" id="L26">        Objects.requireNonNull(columnNames);</span>
<span class="fc bfc" id="L27" title="All 2 branches covered.">        for (String c : columnNames) {</span>
<span class="fc" id="L28">            variableDescriptors.add(new VariableDescriptor(c, null, tableName));</span>
<span class="fc" id="L29">        }</span>
<span class="fc" id="L30">    }</span>

<span class="fc" id="L32">    public QueryResult(ResultSet resultSet) {</span>

<span class="fc bfc" id="L34" title="All 2 branches covered.">        if (resultSet == null) {</span>
<span class="fc" id="L35">            return;</span>
        }

        try {
<span class="fc" id="L39">            ResultSetMetaData md = resultSet.getMetaData();</span>

<span class="fc bfc" id="L41" title="All 2 branches covered.">            for (int i = 0; i &lt; md.getColumnCount(); i++) {</span>
<span class="fc" id="L42">                int index = i + 1;</span>
<span class="fc" id="L43">                VariableDescriptor desc = new VariableDescriptor(</span>
<span class="fc" id="L44">                        md.getColumnName(index),</span>
<span class="fc" id="L45">                        md.getColumnLabel(index),</span>
<span class="fc" id="L46">                        md.getTableName(index)</span>
                );
<span class="fc" id="L48">                variableDescriptors.add(desc);</span>
            }

<span class="fc bfc" id="L51" title="All 2 branches covered.">            while (resultSet.next()) {</span>
<span class="fc" id="L52">                List&lt;Object&gt; row = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L53" title="All 2 branches covered.">                for (int i = 0; i &lt; md.getColumnCount(); i++) {</span>
<span class="fc" id="L54">                    Object value = resultSet.getObject(i + 1);</span>
<span class="fc" id="L55">                    row.add(value);</span>
                }
<span class="fc" id="L57">                rows.add(new DataRow(variableDescriptors, row));</span>
<span class="fc" id="L58">            }</span>

<span class="nc" id="L60">        } catch (Exception e) {</span>
<span class="nc" id="L61">            throw new RuntimeException(e);</span>
<span class="fc" id="L62">        }</span>
<span class="fc" id="L63">    }</span>

    public void addRow(DataRow row) {
<span class="pc bpc" id="L66" title="1 of 2 branches missed.">        if (!sameVariableNames(row)) {</span>
<span class="nc" id="L67">            throw new IllegalArgumentException(&quot;Variable name mismatch&quot;);</span>
        }
<span class="fc" id="L69">        rows.add(row);</span>
<span class="fc" id="L70">    }</span>

    public boolean sameVariableNames(DataRow row) {
<span class="pc bpc" id="L73" title="1 of 2 branches missed.">        if (variableDescriptors.size() != row.getVariableDescriptors().size()) {</span>
<span class="nc" id="L74">            return false;</span>
        }
<span class="fc bfc" id="L76" title="All 2 branches covered.">        for (int i = 0; i &lt; variableDescriptors.size(); i++) {</span>
<span class="fc" id="L77">            VariableDescriptor a = variableDescriptors.get(i);</span>
<span class="fc" id="L78">            VariableDescriptor b = row.getVariableDescriptors().get(i);</span>
<span class="pc bpc" id="L79" title="1 of 2 branches missed.">            if (!a.equals(b)) {</span>
<span class="nc" id="L80">                return false;</span>
            }
        }

<span class="fc" id="L84">        return true;</span>
    }

    public List&lt;DataRow&gt; seeRows() {
<span class="fc" id="L88">        return rows;</span>
    }

    public boolean isEmpty() {
<span class="fc" id="L92">        return rows.isEmpty();</span>
    }

    public int size(){
<span class="fc" id="L96">        return rows.size();</span>
    }

    @Override
    public String toString() {

<span class="nc bnc" id="L102" title="All 2 branches missed.">        if (variableDescriptors.isEmpty()) {</span>
<span class="nc" id="L103">            return &quot;EMPTY&quot;;</span>
        }

<span class="nc" id="L106">        String header =  variableDescriptors.stream()</span>
<span class="nc" id="L107">                .map(d -&gt; d.toString())</span>
<span class="nc" id="L108">                .collect(Collectors.joining(&quot;,&quot;));</span>

<span class="nc" id="L110">        return header + rows.stream()</span>
<span class="nc" id="L111">                .map(r -&gt; &quot;\n&quot; + r.getAsLine())</span>
<span class="nc" id="L112">                .collect(Collectors.joining());</span>
    }

    public QueryResultDto toDto(){

<span class="fc" id="L117">        QueryResultDto dto = new QueryResultDto();</span>
<span class="pc" id="L118">        dto.rows = rows.stream().map(r -&gt; r.toDto()).collect(Collectors.toList());</span>

<span class="fc" id="L120">        return dto;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>