<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>HeuristicsCalculator.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">evomaster-project-report</a> &gt; <a href="../index.html" class="el_bundle">evomaster-client-java-controller</a> &gt; <a href="index.source.html" class="el_package">org.evomaster.client.java.controller.internal.db</a> &gt; <span class="el_source">HeuristicsCalculator.java</span></div><h1>HeuristicsCalculator.java</h1><pre class="source lang-java linenums">package org.evomaster.client.java.controller.internal.db;

import net.sf.jsqlparser.expression.*;
import net.sf.jsqlparser.expression.operators.conditional.AndExpression;
import net.sf.jsqlparser.expression.operators.conditional.OrExpression;
import net.sf.jsqlparser.expression.operators.relational.*;
import net.sf.jsqlparser.schema.Column;
import org.evomaster.client.java.controller.db.DataRow;
import org.evomaster.client.java.utils.SimpleLogger;
import org.evomaster.client.java.instrumentation.testability.StringTransformer;

import java.util.Collections;
import java.util.HashMap;
import java.util.Map;
import java.util.Objects;

<span class="pc bpc" id="L17" title="1 of 2 branches missed.">public class HeuristicsCalculator {</span>


    private final SqlNameContext context;

<span class="fc" id="L22">    public HeuristicsCalculator(SqlNameContext context) {</span>
<span class="fc" id="L23">        this.context = Objects.requireNonNull(context);</span>
<span class="fc" id="L24">    }</span>

    public double computeExpression(Expression exp, DataRow data) {

        //TODO all cases

<span class="fc bfc" id="L30" title="All 2 branches covered.">        if (exp instanceof ComparisonOperator) {</span>
<span class="fc" id="L31">            return computeComparisonOperator((ComparisonOperator) exp, data);</span>
        }
<span class="fc bfc" id="L33" title="All 2 branches covered.">        if (exp instanceof AndExpression) {</span>
<span class="fc" id="L34">            return computeAnd((AndExpression) exp, data);</span>
        }
<span class="fc bfc" id="L36" title="All 2 branches covered.">        if (exp instanceof OrExpression) {</span>
<span class="fc" id="L37">            return computeOr((OrExpression) exp, data);</span>
        }
<span class="fc bfc" id="L39" title="All 2 branches covered.">        if (exp instanceof IsNullExpression) {</span>
<span class="fc" id="L40">            return computeIsNull((IsNullExpression) exp, data);</span>
        }
<span class="fc bfc" id="L42" title="All 2 branches covered.">        if (exp instanceof InExpression) {</span>
<span class="fc" id="L43">            return computeInExpression((InExpression) exp, data);</span>
        }
<span class="pc bpc" id="L45" title="1 of 2 branches missed.">        if (exp instanceof Parenthesis) {</span>
<span class="fc" id="L46">            return computeExpression(((Parenthesis) exp).getExpression(), data);</span>
        }

<span class="nc" id="L49">        return cannotHandle(exp);</span>
    }

    private double computeInExpression(InExpression exp, DataRow data) {

        //TODO can left be a list???

<span class="fc" id="L56">        ItemsList itemsList = exp.getRightItemsList();</span>
<span class="pc bpc" id="L57" title="1 of 2 branches missed.">        if (itemsList instanceof ExpressionList) {</span>
<span class="fc" id="L58">            ExpressionList list = (ExpressionList) itemsList;</span>

<span class="fc bfc" id="L60" title="All 2 branches covered.">            if (exp.isNot()) {</span>

<span class="fc" id="L62">                double max = 0;</span>

<span class="fc bfc" id="L64" title="All 2 branches covered.">                for (Expression element : list.getExpressions()) {</span>
<span class="fc" id="L65">                    ComparisonOperator op = new NotEqualsTo();</span>
<span class="fc" id="L66">                    op.setLeftExpression(exp.getLeftExpression());</span>
<span class="fc" id="L67">                    op.setRightExpression(element);</span>

<span class="fc" id="L69">                    double dist = computeComparisonOperator(op, data);</span>
<span class="fc bfc" id="L70" title="All 2 branches covered.">                    if (dist &gt; max) {</span>
<span class="fc" id="L71">                        max = dist;</span>
<span class="fc" id="L72">                        break; // no need to look at others, as no gradient</span>
                    }
<span class="fc" id="L74">                }</span>

<span class="fc" id="L76">                return max;</span>

            } else {

<span class="fc" id="L80">                double min = Double.MAX_VALUE;</span>

<span class="fc bfc" id="L82" title="All 2 branches covered.">                for (Expression element : list.getExpressions()) {</span>
<span class="fc" id="L83">                    ComparisonOperator op = new EqualsTo();</span>
<span class="fc" id="L84">                    op.setLeftExpression(exp.getLeftExpression());</span>
<span class="fc" id="L85">                    op.setRightExpression(element);</span>

<span class="fc" id="L87">                    double dist = computeComparisonOperator(op, data);</span>
<span class="fc bfc" id="L88" title="All 2 branches covered.">                    if (dist &lt; min) {</span>
<span class="fc" id="L89">                        min = dist;</span>
                    }
<span class="fc" id="L91">                }</span>

<span class="fc" id="L93">                return min;</span>
            }

        } else {
<span class="nc" id="L97">            return cannotHandle(exp);</span>
        }
    }

    private double computeIsNull(IsNullExpression exp, DataRow data) {

<span class="fc" id="L103">        Object x = getValue(exp.getLeftExpression(), data);</span>

<span class="fc bfc" id="L105" title="All 4 branches covered.">        if (x == null &amp;&amp; !exp.isNot()) {</span>
<span class="fc" id="L106">            return 0d;</span>
        }
<span class="fc bfc" id="L108" title="All 4 branches covered.">        if (x != null &amp;&amp; exp.isNot()) {</span>
<span class="fc" id="L109">            return 0d;</span>
        }

<span class="fc" id="L112">        return 1;</span>
    }

    private double cannotHandle(Expression exp) {
<span class="nc" id="L116">        SimpleLogger.uniqueWarn(&quot;WARNING, cannot handle SQL expression type '&quot; + exp.getClass().getSimpleName() +</span>
<span class="nc" id="L117">                &quot;' with value: &quot; + exp.toString());</span>
<span class="nc" id="L118">        return Double.MAX_VALUE;</span>
    }


    private double computeAnd(AndExpression exp, DataRow data) {

<span class="fc" id="L124">        double a = computeExpression(exp.getLeftExpression(), data);</span>
<span class="fc" id="L125">        double b = computeExpression(exp.getRightExpression(), data);</span>

<span class="fc" id="L127">        double sum = a + b;</span>
<span class="pc bpc" id="L128" title="1 of 2 branches missed.">        if (sum &lt; Math.max(a, b)) {</span>
            //overflow
<span class="nc" id="L130">            return Double.MAX_VALUE;</span>
        } else {
<span class="fc" id="L132">            return sum;</span>
        }
    }

    private double computeOr(OrExpression exp, DataRow data) {

<span class="fc" id="L138">        double a = computeExpression(exp.getLeftExpression(), data);</span>
<span class="fc" id="L139">        double b = computeExpression(exp.getRightExpression(), data);</span>

<span class="fc" id="L141">        return Math.min(a, b);</span>
    }

    private double computeComparisonOperator(ComparisonOperator exp, DataRow data) {

<span class="fc" id="L146">        Object left = getValue(exp.getLeftExpression(), data);</span>
<span class="fc" id="L147">        Object right = getValue(exp.getRightExpression(), data);</span>

<span class="pc bpc" id="L149" title="1 of 4 branches missed.">        if (left instanceof Number &amp;&amp; right instanceof Number) {</span>
<span class="fc" id="L150">            double x = ((Number) left).doubleValue();</span>
<span class="fc" id="L151">            double y = ((Number) right).doubleValue();</span>

<span class="fc" id="L153">            return computerComparison(x, y, exp);</span>
        }

<span class="fc bfc" id="L156" title="All 4 branches covered.">        if (left instanceof String &amp;&amp; right instanceof String) {</span>
<span class="fc" id="L157">            return computeComparison(left.toString(), right.toString(), exp);</span>
        }

<span class="pc bpc" id="L160" title="1 of 4 branches missed.">        if (left instanceof Boolean &amp;&amp; right instanceof Boolean) {</span>
<span class="fc" id="L161">            return computeBooleanComparison((Boolean) left, (Boolean) right, exp);</span>
        }

<span class="pc bpc" id="L164" title="1 of 4 branches missed.">        if (left == null || right == null) {</span>
<span class="fc" id="L165">            return computeNullComparison(left, right, exp);</span>
        }

<span class="nc" id="L168">        return cannotHandle(exp);</span>
    }

    private double computeBooleanComparison(boolean x, boolean y, ComparisonOperator exp) {
<span class="pc bpc" id="L172" title="1 of 2 branches missed.">        if (!checkEqualOrNotOperator(exp)) {</span>
<span class="nc" id="L173">            return cannotHandle(exp);</span>
        }

<span class="fc bfc" id="L176" title="All 4 branches covered.">        if (exp instanceof EqualsTo &amp;&amp; x == y) {</span>
<span class="fc" id="L177">            return 0d;</span>
        }
<span class="fc bfc" id="L179" title="All 4 branches covered.">        if (exp instanceof NotEqualsTo &amp;&amp; x != y) {</span>
<span class="fc" id="L180">            return 0d;</span>
        }

<span class="fc" id="L183">        return 1d;</span>
    }

    private boolean checkEqualOrNotOperator(ComparisonOperator exp) {
<span class="pc bpc" id="L187" title="1 of 4 branches missed.">        return (exp instanceof EqualsTo) || (exp instanceof NotEqualsTo);</span>
    }

    private double computeNullComparison(Object x, Object y, ComparisonOperator exp) {

<span class="pc bpc" id="L192" title="2 of 6 branches missed.">        assert x == null || y == null;</span>

<span class="pc bpc" id="L194" title="1 of 2 branches missed.">        if (!checkEqualOrNotOperator(exp)) {</span>
<span class="nc" id="L195">            return cannotHandle(exp);</span>
        }

<span class="fc bfc" id="L198" title="All 4 branches covered.">        if (exp instanceof EqualsTo &amp;&amp; x == y) {</span>
<span class="fc" id="L199">            return 0d;</span>
        }
<span class="fc bfc" id="L201" title="All 4 branches covered.">        if (exp instanceof NotEqualsTo &amp;&amp; x != y) {</span>
<span class="fc" id="L202">            return 0d;</span>
        }
<span class="fc" id="L204">        return Double.MAX_VALUE;</span>
    }

    private double computerComparison(double x, double y, ComparisonOperator exp) {

<span class="fc bfc" id="L209" title="All 2 branches covered.">        if (exp instanceof EqualsTo) {</span>
<span class="fc" id="L210">            return Math.abs(x - y);</span>
<span class="fc bfc" id="L211" title="All 2 branches covered.">        } else if (exp instanceof GreaterThanEquals) {</span>
<span class="fc bfc" id="L212" title="All 2 branches covered.">            return x &gt;= y ? 0d : y - x;</span>
<span class="fc bfc" id="L213" title="All 2 branches covered.">        } else if (exp instanceof GreaterThan) {</span>
<span class="fc bfc" id="L214" title="All 2 branches covered.">            return x &gt; y ? 0d : 1d + y - x;</span>
<span class="fc bfc" id="L215" title="All 2 branches covered.">        } else if (exp instanceof MinorThanEquals) {</span>
<span class="fc bfc" id="L216" title="All 2 branches covered.">            return x &lt;= y ? 0d : x - y;</span>
<span class="fc bfc" id="L217" title="All 2 branches covered.">        } else if (exp instanceof MinorThan) {</span>
<span class="fc bfc" id="L218" title="All 2 branches covered.">            return x &lt; y ? 0d : 1d + (x - y);</span>
<span class="pc bpc" id="L219" title="1 of 2 branches missed.">        } else if (exp instanceof NotEqualsTo) {</span>
<span class="fc bfc" id="L220" title="All 2 branches covered.">            return x != y ? 0d : 1d;</span>
        } else {
<span class="nc" id="L222">            return cannotHandle(exp);</span>
        }
    }

    private double computeComparison(String a, String b, ComparisonOperator exp) {

<span class="fc bfc" id="L228" title="All 2 branches covered.">        if (exp instanceof EqualsTo) {</span>
<span class="fc" id="L229">            return StringTransformer.getLeftAlignmentDistance(a, b);</span>
<span class="pc bpc" id="L230" title="1 of 2 branches missed.">        } else if (exp instanceof NotEqualsTo) {</span>
<span class="fc bfc" id="L231" title="All 2 branches covered.">            if (a.equals(b)) {</span>
<span class="fc" id="L232">                return Double.MAX_VALUE;</span>
            } else {
<span class="fc" id="L234">                return 0d;</span>
            }
        } else {
<span class="nc" id="L237">            return cannotHandle(exp);</span>
        }
    }


    private Object getValue(Expression exp, DataRow data) {

        //TODO all cases

<span class="fc bfc" id="L246" title="All 2 branches covered.">        if (exp instanceof Column) {</span>
<span class="fc" id="L247">            Column column = (Column) exp;</span>

<span class="fc" id="L249">            String name = column.getColumnName();</span>
<span class="fc" id="L250">            String table = context.getTableName(column);</span>

<span class="fc" id="L252">            return data.getValueByName(name, table);</span>

<span class="fc bfc" id="L254" title="All 2 branches covered.">        } else if (exp instanceof Parenthesis) {</span>
<span class="fc" id="L255">            return getValue(((Parenthesis) exp).getExpression(), data);</span>
<span class="fc bfc" id="L256" title="All 2 branches covered.">        } else if (exp instanceof LongValue) {</span>
<span class="fc" id="L257">            return ((LongValue) exp).getValue();</span>
<span class="fc bfc" id="L258" title="All 2 branches covered.">        } else if (exp instanceof StringValue) {</span>
<span class="fc" id="L259">            return ((StringValue) exp).getNotExcapedValue();</span>
<span class="fc bfc" id="L260" title="All 2 branches covered.">        } else if (exp instanceof NullValue) {</span>
<span class="fc" id="L261">            return null;</span>
<span class="pc bpc" id="L262" title="1 of 2 branches missed.">        } else if (exp instanceof SignedExpression) {</span>
<span class="fc" id="L263">            SignedExpression signed = (SignedExpression) exp;</span>
<span class="fc" id="L264">            Object base = getValue(signed.getExpression(), data);</span>
<span class="pc bpc" id="L265" title="1 of 2 branches missed.">            if (signed.getSign() != '-') {</span>
<span class="nc" id="L266">                return base;</span>
            } else {
<span class="pc bpc" id="L268" title="1 of 2 branches missed.">                if (base instanceof Long) {</span>
<span class="fc" id="L269">                    return -(Long) base;</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">                } else if (base instanceof Double) {</span>
<span class="nc" id="L271">                    return -(Double) base;</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">                } else if (base instanceof Float) {</span>
<span class="nc" id="L273">                    return -(Float) base;</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">                } else if (base instanceof Integer) {</span>
<span class="nc" id="L275">                    return -(Integer) base;</span>
                } else {
<span class="nc" id="L277">                    cannotHandle(exp);</span>
<span class="nc" id="L278">                    return null;</span>
                }
            }
        } else {
<span class="nc" id="L282">            cannotHandle(exp);</span>
<span class="nc" id="L283">            return null;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>