<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>ClassScanner.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">evomaster-project-report</a> &gt; <a href="../index.html" class="el_bundle">evomaster-client-java-instrumentation</a> &gt; <a href="index.source.html" class="el_package">org.evomaster.client.java.instrumentation</a> &gt; <span class="el_source">ClassScanner.java</span></div><h1>ClassScanner.java</h1><pre class="source lang-java linenums">package org.evomaster.client.java.instrumentation;

import org.evomaster.client.java.utils.SimpleLogger;

import java.io.File;
import java.io.IOException;
import java.net.URI;
import java.net.URL;
import java.net.URLClassLoader;
import java.util.*;
import java.util.jar.JarEntry;
import java.util.jar.JarFile;
import java.util.stream.Collectors;

<span class="nc" id="L15">public class ClassScanner {</span>

    public static void forceLoading(String packagePrefixes){
<span class="nc" id="L18">        forceLoading(findAllClassNames(packagePrefixes));</span>
<span class="nc" id="L19">    }</span>

    public static void forceLoading(Set&lt;ClassName&gt; names) {

<span class="nc" id="L23">        ClassLoader loader = ClassScanner.class.getClassLoader();</span>

<span class="nc bnc" id="L25" title="All 2 branches missed.">        for (ClassName name : names) {</span>
            try {
<span class="nc" id="L27">                loader.loadClass(name.getFullNameWithDots());</span>
<span class="nc" id="L28">            } catch (Exception e) {</span>
<span class="nc" id="L29">                SimpleLogger.error(&quot;Failed to load &quot; + name.getFullNameWithDots() + &quot; : &quot; + e.getMessage());</span>
<span class="nc" id="L30">            }</span>
<span class="nc" id="L31">        }</span>
<span class="nc" id="L32">    }</span>


    public static Set&lt;ClassName&gt; findAllClassNames(String packagePrefixes) {

<span class="nc" id="L37">        List&lt;String&gt; prefixes = Arrays.asList(packagePrefixes.split(&quot;,&quot;))</span>
<span class="nc" id="L38">                .stream()</span>
<span class="nc" id="L39">                .map(s -&gt; s.trim())</span>
<span class="nc bnc" id="L40" title="All 2 branches missed.">                .filter(s -&gt; !s.isEmpty())</span>
<span class="nc" id="L41">                .collect(Collectors.toList());</span>

<span class="nc" id="L43">        Set&lt;ClassName&gt; names = new HashSet&lt;&gt;();</span>

<span class="nc" id="L45">        searchInCurrentClassLoaderIfUrlOne(prefixes, names);</span>

        /*
            TODO: this ll need to be updated when Java 9.
            And also we need special handling for Spring.
         */

<span class="nc" id="L52">        return names;</span>
    }


    private static void searchInCurrentClassLoaderIfUrlOne(List&lt;String&gt; prefixes, Set&lt;ClassName&gt; names) {

<span class="nc" id="L58">        ClassLoader loader = ClassScanner.class.getClassLoader();</span>

<span class="nc bnc" id="L60" title="All 2 branches missed.">        while (loader != null) {</span>
<span class="nc bnc" id="L61" title="All 2 branches missed.">            if (loader instanceof URLClassLoader) {</span>
<span class="nc" id="L62">                URLClassLoader urlLoader = (URLClassLoader) loader;</span>
<span class="nc bnc" id="L63" title="All 2 branches missed.">                for (URL url : urlLoader.getURLs()) {</span>
                    try {
<span class="nc" id="L65">                        URI uri = url.toURI();</span>

<span class="nc" id="L67">                        File file = new File(uri);</span>
<span class="nc" id="L68">                        String path = file.getAbsolutePath();</span>

<span class="nc bnc" id="L70" title="All 2 branches missed.">                        if(file.isDirectory()){</span>
<span class="nc" id="L71">                            scanDirectory(prefixes, names, file, path);</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">                        } else if(path.endsWith(&quot;.jar&quot;)){</span>
<span class="nc" id="L73">                            scanJar(prefixes, names, path);</span>
                        }

<span class="nc" id="L76">                    } catch (Exception e) {</span>
<span class="nc" id="L77">                        SimpleLogger.error(&quot;Error while parsing URL &quot; + url);</span>
<span class="nc" id="L78">                        continue;</span>
<span class="nc" id="L79">                    }</span>
                }
            }

<span class="nc" id="L83">            loader = loader.getParent();</span>
        }
<span class="nc" id="L85">    }</span>


    private static void scanDirectory(List&lt;String&gt; prefixes,
                               Set&lt;ClassName&gt; names,
                               File directory,
                               String classPathFolder) {

<span class="nc bnc" id="L93" title="All 4 branches missed.">        if (!directory.exists() || !directory.isDirectory()) {</span>
<span class="nc" id="L94">            return;</span>
        }

<span class="nc bnc" id="L97" title="All 2 branches missed.">        if (!directory.canRead()) {</span>
<span class="nc" id="L98">            SimpleLogger.warn(&quot;No permission to read: &quot; + directory.getAbsolutePath());</span>
<span class="nc" id="L99">            return;</span>
        }

<span class="nc bnc" id="L102" title="All 2 branches missed.">        for (File file : directory.listFiles()) {</span>

<span class="nc" id="L104">            String relativeFilePath = file.getAbsolutePath()</span>
<span class="nc" id="L105">                    .replace(classPathFolder + File.separator, &quot;&quot;);</span>

<span class="nc bnc" id="L107" title="All 4 branches missed.">            if (file.isDirectory() &amp;&amp; isAPotentialPrefix(relativeFilePath, prefixes)) {</span>
                // recursion till we get to a file that is not a folder.
<span class="nc" id="L109">                scanDirectory(prefixes, names, file, classPathFolder);</span>

            } else {
<span class="nc bnc" id="L112" title="All 2 branches missed.">                if (!file.getName().endsWith(&quot;.class&quot;)) {</span>
<span class="nc" id="L113">                    continue; // we are only interested in class files</span>
                }

<span class="nc" id="L116">                ClassName className =  ClassName.get(relativeFilePath);</span>

<span class="nc bnc" id="L118" title="All 2 branches missed.">                if(isAMatch(className.getFullNameWithDots(), prefixes)){</span>
<span class="nc" id="L119">                    names.add(className);</span>
                }
            }
        }
<span class="nc" id="L123">    }</span>

    private static boolean isAPotentialPrefix(String folder, List&lt;String&gt; prefixes){

<span class="nc" id="L127">        final String p = folder.replace(File.separatorChar, '.');</span>

<span class="nc" id="L129">        return prefixes.stream()</span>
<span class="nc" id="L130">                .anyMatch(s -&gt; s.startsWith(p));</span>
    }

    private static boolean isAMatch(String name, List&lt;String&gt; prefixes){

<span class="nc" id="L135">        return prefixes.stream()</span>
<span class="nc" id="L136">                .anyMatch(s -&gt; name.startsWith(s));</span>
    }

    private static void scanJar(List&lt;String&gt; prefixes,
                                Set&lt;ClassName&gt; names,
                                String jarEntry) {

<span class="nc" id="L143">        try(JarFile zf = new JarFile(jarEntry)) {</span>

<span class="nc" id="L145">            Enumeration&lt;?&gt; e = zf.entries();</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">            while (e.hasMoreElements()) {</span>
<span class="nc" id="L147">                JarEntry ze = (JarEntry) e.nextElement();</span>
<span class="nc" id="L148">                String entryName = ze.getName();</span>

<span class="nc bnc" id="L150" title="All 2 branches missed.">                if (!entryName.endsWith(&quot;.class&quot;)) {</span>
<span class="nc" id="L151">                    continue;</span>
                }

<span class="nc" id="L154">                ClassName className =  ClassName.get(entryName);</span>

<span class="nc bnc" id="L156" title="All 2 branches missed.">                if(isAMatch(className.getFullNameWithDots(), prefixes)){</span>
<span class="nc" id="L157">                    names.add(className);</span>
                }
<span class="nc" id="L159">            }</span>
<span class="nc" id="L160">        } catch (IOException e) {</span>
<span class="nc" id="L161">            SimpleLogger.error(&quot;Failed to open jar &quot; + jarEntry + &quot; : &quot; + e.getMessage());</span>
<span class="nc" id="L162">        }</span>
<span class="nc" id="L163">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>