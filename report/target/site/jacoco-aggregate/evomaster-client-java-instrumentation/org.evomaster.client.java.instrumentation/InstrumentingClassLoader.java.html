<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>InstrumentingClassLoader.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">evomaster-project-report</a> &gt; <a href="../index.html" class="el_bundle">evomaster-client-java-instrumentation</a> &gt; <a href="index.source.html" class="el_package">org.evomaster.client.java.instrumentation</a> &gt; <span class="el_source">InstrumentingClassLoader.java</span></div><h1>InstrumentingClassLoader.java</h1><pre class="source lang-java linenums">package org.evomaster.client.java.instrumentation;

import org.objectweb.asm.ClassReader;

import java.io.InputStream;
import java.util.LinkedHashMap;
import java.util.Map;

import static org.evomaster.client.java.utils.SimpleLogger.*;


/**
 * This classloader will add probes to the loaded classes.
 * Although such probes might make the classes slower to execute,
 * these probes should not change the behavior of the instrumented
 * classes.
 * If they do, then it is either a problem related to timing, or
 * a bug in this library.
 * &lt;br&gt;
 * This is needed ONLY when the test cases are generated, and not
 * when they are run.
 * &lt;br&gt;
 * Note: this class loader can only be used during testing of EM.
 * For user controllers, we have to use a Java Agent that can intercept
 * ALL class loading.
 * The problem is that there are some packages we cannot instrument (eg javax.)
 * otherwise it becomes a nightmare to handle. But those packages could
 * use reflection to load classes that we do instrument.
 * In the moment we delegate to super classloader for those packages, we are
 * screwed, as some classes could be loaded twice.
 * An example is in javax.validation.Validation which can re-load hibernate
 * classes by searching for &quot;default providers&quot;.
 */
public class InstrumentingClassLoader extends ClassLoader {

    private final Instrumentator instrumentator;
    private final ClassLoader classLoader;
    private final Map&lt;String, Class&lt;?&gt;&gt; classes;

    /**
     * Classloader needed to bootstrap the execution of your application.
     * This is needed because it will apply bytecode instrumentation to keep
     * track of which parts of the code is executed, and to inject heuristics
     * to help the generation of test cases that maximize coverage
     *
     * @param packagePrefixesToCover: a &quot;,&quot; separated list of package prefixes or class names.
     *                              For example, &quot;com.foo.,com.bar.Bar&quot;.
     *                              Note: be careful of using something as generate as &quot;com.&quot;
     *                              or &quot;org.&quot;, as most likely ALL your third-party libraries
     *                              would be instrumented as well, which could have a severe
     *                              impact on performance
     * @throws IllegalArgumentException if {@code packagePrefixesToCover} is invalid
     */
<span class="nc" id="L54">    public InstrumentingClassLoader(String packagePrefixesToCover)throws IllegalArgumentException {</span>
<span class="nc" id="L55">        instrumentator = new Instrumentator(packagePrefixesToCover);</span>
<span class="nc" id="L56">        classLoader = InstrumentingClassLoader.class.getClassLoader();</span>
<span class="nc" id="L57">        classes = new LinkedHashMap&lt;&gt;();</span>
<span class="nc" id="L58">    }</span>

    @Override
    public Class&lt;?&gt; loadClass(String name) throws ClassNotFoundException {

<span class="nc bnc" id="L63" title="All 2 branches missed.">        if (!ClassesToExclude.checkIfCanInstrument(ClassName.get(name))) {</span>
<span class="nc" id="L64">            return loadNonInstrumented(name);</span>
        }

<span class="nc" id="L67">        Class&lt;?&gt; result = classes.get(name);</span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">        if (result != null) {</span>
<span class="nc" id="L69">            return result;</span>
        } else {
<span class="nc" id="L71">            ClassName className = new ClassName(name);</span>
<span class="nc" id="L72">            Class&lt;?&gt; instrumentedClass = instrumentClass(className);</span>

<span class="nc bnc" id="L74" title="All 2 branches missed.">            if(instrumentedClass == null){</span>
<span class="nc" id="L75">                return loadNonInstrumented(name);</span>
            }

<span class="nc" id="L78">            return instrumentedClass;</span>
        }
    }

    private Class&lt;?&gt; loadNonInstrumented(String name) throws ClassNotFoundException {
<span class="nc" id="L83">        Class&lt;?&gt; result = findLoadedClass(name);</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">        if (result != null) {</span>
<span class="nc" id="L85">            return result;</span>
        }
<span class="nc" id="L87">        result = classLoader.loadClass(name);</span>
<span class="nc" id="L88">        return result;</span>
    }

    private Class&lt;?&gt; instrumentClass(ClassName className) throws ClassNotFoundException {

<span class="nc" id="L93">        try (InputStream is = classLoader.getResourceAsStream(className.getAsResourcePath())) {</span>

<span class="nc bnc" id="L95" title="All 2 branches missed.">            if (is == null) {</span>
<span class="nc" id="L96">                warn(&quot;Failed to find resource file for &quot;+className.getAsResourcePath());</span>
<span class="nc" id="L97">                return null;</span>
            }

<span class="nc" id="L100">            byte[] byteBuffer = instrumentator.transformBytes(this, className, new ClassReader(is));</span>
<span class="nc" id="L101">            createPackageDefinition(className.getFullNameWithDots());</span>

<span class="nc" id="L103">            Class&lt;?&gt; result = defineClass(className.getFullNameWithDots(), byteBuffer, 0, byteBuffer.length);</span>
<span class="nc" id="L104">            classes.put(className.getFullNameWithDots(), result);</span>

<span class="nc" id="L106">            debug(&quot;Loaded class: &quot; + className.getFullNameWithDots());</span>
<span class="nc" id="L107">            return result;</span>
<span class="nc" id="L108">        } catch (Throwable t) {</span>
<span class="nc" id="L109">            error(&quot;Error while loading class &quot; + className.getFullNameWithDots(), t);</span>
<span class="nc" id="L110">            return null;</span>
        }
    }

    /**
     * Before a new class is defined, we need to create a package definition for it
     *
     * @param className
     */
    private void createPackageDefinition(String className) {
<span class="nc" id="L120">        int i = className.lastIndexOf('.');</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">        if (i != -1) {</span>
<span class="nc" id="L122">            String pkgname = className.substring(0, i);</span>
            // Check if package already loaded.
<span class="nc" id="L124">            Package pkg = getPackage(pkgname);</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">            if (pkg == null) {</span>
<span class="nc" id="L126">                definePackage(pkgname, null, null, null, null, null, null, null);</span>
            }
        }
<span class="nc" id="L129">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>